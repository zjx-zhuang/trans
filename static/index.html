<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive â†’ BigQuery SQL è½¬æ¢å™¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --code-bg: #0d1117;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            min-height: calc(100vh - 100px);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Panels */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .panel-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .panel-title-icon.hive {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
        }

        .panel-title-icon.bq {
            background: linear-gradient(135deg, #4285f4, #34a853);
        }

        .panel-title-icon.info {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
        }

        .panel-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        /* Code Editor */
        .code-editor {
            flex: 1;
            position: relative;
        }

        .code-textarea {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .code-textarea:focus {
            border-color: var(--accent-blue);
        }

        .code-textarea::placeholder {
            color: var(--text-secondary);
        }

        .code-output {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 166, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-icon {
            font-size: 1.1rem;
        }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Panel */
        .info-panel {
            grid-column: 1 / -1;
        }

        .info-content {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .info-line {
            padding: 0.25rem 0;
            display: flex;
            gap: 0.5rem;
        }

        .info-time {
            color: var(--text-secondary);
            min-width: 100px;
        }

        .info-level {
            font-weight: 600;
            min-width: 60px;
        }

        .info-level.info { color: var(--accent-blue); }
        .info-level.success { color: var(--accent-green); }
        .info-level.warning { color: var(--accent-yellow); }
        .info-level.error { color: var(--accent-red); }

        .info-message {
            color: var(--text-primary);
        }

        /* Status Cards */
        .status-cards {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .status-card {
            flex: 1;
            min-width: 150px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .status-card-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .status-card-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-card-value.success { color: var(--accent-green); }
        .status-card-value.error { color: var(--accent-red); }
        .status-card-value.pending { color: var(--text-secondary); }

        /* Copy Button */
        .copy-btn {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ”„</div>
                <div class="logo-text">
                    <h1>SQL Transformer</h1>
                    <span>Hive â†’ BigQuery æ™ºèƒ½è½¬æ¢</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æœåŠ¡å°±ç»ª</span>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Input Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-title-icon hive">ğŸ</div>
                    <span>Hive SQL è¾“å…¥</span>
                </div>
                <button class="copy-btn" onclick="clearInput()">æ¸…ç©º</button>
            </div>
            <div class="panel-body">
                <div class="code-editor">
                    <textarea 
                        class="code-textarea" 
                        id="hiveSql" 
                        placeholder="åœ¨æ­¤è¾“å…¥ Hive SQL è¯­å¥...

ç¤ºä¾‹:
SELECT 
    user_id,
    COUNT(*) as cnt
FROM my_table
WHERE d = '2024-01-01'
GROUP BY user_id"
                    ></textarea>
                </div>
                <div class="action-bar">
                    <button class="btn btn-primary" id="convertBtn" onclick="convertSql()">
                        <span class="btn-icon">âš¡</span>
                        <span id="convertBtnText">å¼€å§‹è½¬æ¢</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadSample()">
                        <span class="btn-icon">ğŸ“„</span>
                        åŠ è½½ç¤ºä¾‹
                    </button>
                </div>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-title-icon bq">ğŸ“Š</div>
                    <span>BigQuery SQL è¾“å‡º</span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="copy-btn" id="saveBtn" onclick="saveResult()" style="display: none;">ğŸ’¾ ä¿å­˜</button>
                    <button class="copy-btn" id="copyBtn" onclick="copyOutput()">å¤åˆ¶</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="status-cards">
                    <div class="status-card">
                        <div class="status-card-label">Hive éªŒè¯</div>
                        <div class="status-card-value pending" id="hiveStatus">-</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-label">BQ éªŒè¯</div>
                        <div class="status-card-value pending" id="bqStatus">-</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-label">é‡è¯•æ¬¡æ•°</div>
                        <div class="status-card-value pending" id="retryCount">-</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-label">éªŒè¯æ¨¡å¼</div>
                        <div class="status-card-value pending" id="validationMode">-</div>
                    </div>
                </div>
                <div class="code-editor">
                    <div class="code-output" id="bqOutput">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>è½¬æ¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="panel info-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-title-icon info">ğŸ“‹</div>
                    <span>å®æ—¶æ—¥å¿—</span>
                </div>
                <button class="copy-btn" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            </div>
            <div class="panel-body">
                <div class="info-content" id="infoPanel">
                    <div class="info-line">
                        <span class="info-time">[ç³»ç»Ÿ]</span>
                        <span class="info-level info">INFO</span>
                        <span class="info-message">SQL è½¬æ¢å™¨å·²å°±ç»ªï¼Œç­‰å¾…è¾“å…¥...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = window.location.origin;
        let isConverting = false;
        let eventSource = null;
        let lastConversionResult = null;  // å­˜å‚¨æœ€åä¸€æ¬¡è½¬æ¢ç»“æœ

        // Log function - add log from frontend
        function addLog(level, message, fromServer = false) {
            const infoPanel = document.getElementById('infoPanel');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const line = document.createElement('div');
            line.className = 'info-line';
            
            const source = fromServer ? 'æœåŠ¡' : 'å‰ç«¯';
            line.innerHTML = `
                <span class="info-time">[${time}]</span>
                <span class="info-level ${level}">${level.toUpperCase()}</span>
                <span class="info-message">${escapeHtml(message)}</span>
            `;
            infoPanel.appendChild(line);
            infoPanel.scrollTop = infoPanel.scrollHeight;
        }

        // Add server log - from SSE
        function addServerLog(logEntry) {
            const infoPanel = document.getElementById('infoPanel');
            const line = document.createElement('div');
            line.className = 'info-line';
            
            const level = logEntry.level || 'info';
            const levelClass = level === 'warning' ? 'warning' : 
                              level === 'error' ? 'error' : 
                              level === 'success' ? 'success' : 'info';
            
            line.innerHTML = `
                <span class="info-time">[${logEntry.time}]</span>
                <span class="info-level ${levelClass}">${level.toUpperCase()}</span>
                <span class="info-message">${escapeHtml(logEntry.message)}</span>
            `;
            infoPanel.appendChild(line);
            infoPanel.scrollTop = infoPanel.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Connect to SSE log stream
        function connectLogStream() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`${API_URL}/logs/stream`);
            
            eventSource.onmessage = (event) => {
                try {
                    const logEntry = JSON.parse(event.data);
                    addServerLog(logEntry);
                } catch (e) {
                    console.error('Failed to parse log entry:', e);
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('SSE connection error:', error);
                // Reconnect after 3 seconds
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CLOSED) {
                        connectLogStream();
                    }
                }, 3000);
            };
            
            eventSource.onopen = () => {
                console.log('SSE connection established');
            };
        }

        // Clear input
        function clearInput() {
            document.getElementById('hiveSql').value = '';
            addLog('info', 'å·²æ¸…ç©ºè¾“å…¥');
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('infoPanel').innerHTML = '';
            addLog('info', 'æ—¥å¿—å·²æ¸…é™¤');
        }

        // Load sample SQL
        function loadSample() {
            const sampleSql = `WITH daily_orders AS (
    SELECT 
        to_date(order_time) AS order_date,
        customer_id,
        SUM(amount) AS daily_amount,
        COUNT(*) AS order_count
    FROM orders
    WHERE order_time >= date_sub(current_date(), 30)
    GROUP BY to_date(order_time), customer_id
)
SELECT 
    customer_id,
    AVG(daily_amount) AS avg_daily_spend,
    SUM(order_count) AS total_orders,
    collect_list(order_date) AS order_dates
FROM daily_orders
GROUP BY customer_id
ORDER BY avg_daily_spend DESC
LIMIT 100`;
            document.getElementById('hiveSql').value = sampleSql;
            addLog('info', 'å·²åŠ è½½ç¤ºä¾‹ SQL');
        }

        // Update status
        function updateStatus(status, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.style.background = status === 'success' ? 'var(--accent-green)' :
                                   status === 'error' ? 'var(--accent-red)' :
                                   status === 'loading' ? 'var(--accent-yellow)' :
                                   'var(--accent-green)';
            text.textContent = message;
        }

        // Update result cards
        function updateResultCards(result) {
            const hiveStatus = document.getElementById('hiveStatus');
            const bqStatus = document.getElementById('bqStatus');
            const retryCount = document.getElementById('retryCount');
            const validationMode = document.getElementById('validationMode');

            hiveStatus.textContent = result.hive_valid ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥';
            hiveStatus.className = 'status-card-value ' + (result.hive_valid ? 'success' : 'error');

            bqStatus.textContent = result.validation_success ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥';
            bqStatus.className = 'status-card-value ' + (result.validation_success ? 'success' : 'error');

            retryCount.textContent = result.retry_count;
            retryCount.className = 'status-card-value';

            validationMode.textContent = result.validation_mode || '-';
            validationMode.className = 'status-card-value';
        }

        // Clear previous conversion cache
        function clearConversionCache() {
            // æ¸…é™¤ä¸Šæ¬¡è½¬æ¢ç»“æœ
            lastConversionResult = null;
            
            // éšè—ä¿å­˜æŒ‰é’®
            document.getElementById('saveBtn').style.display = 'none';
            
            // é‡ç½®çŠ¶æ€å¡ç‰‡
            document.getElementById('hiveStatus').textContent = '-';
            document.getElementById('hiveStatus').className = 'status-card-value pending';
            document.getElementById('bqStatus').textContent = '-';
            document.getElementById('bqStatus').className = 'status-card-value pending';
            document.getElementById('retryCount').textContent = '-';
            document.getElementById('retryCount').className = 'status-card-value pending';
            document.getElementById('validationMode').textContent = '-';
            document.getElementById('validationMode').className = 'status-card-value pending';
            
            // é‡ç½®è¾“å‡ºåŒºåŸŸ
            document.getElementById('bqOutput').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div>æ­£åœ¨è½¬æ¢ï¼Œè¯·ç¨å€™...</div>
                </div>
            `;
        }

        // Convert SQL
        async function convertSql() {
            if (isConverting) return;

            const hiveSql = document.getElementById('hiveSql').value.trim();
            if (!hiveSql) {
                addLog('warning', 'è¯·è¾“å…¥ Hive SQL');
                return;
            }

            isConverting = true;
            const btn = document.getElementById('convertBtn');
            const btnText = document.getElementById('convertBtnText');
            
            // æ¸…é™¤ä¸Šæ¬¡è½¬æ¢çš„ç¼“å­˜
            clearConversionCache();
            addLog('info', 'å¼€å§‹æ–°çš„è½¬æ¢ä»»åŠ¡...');
            
            btn.disabled = true;
            btnText.innerHTML = '<div class="spinner"></div> è½¬æ¢ä¸­...';
            updateStatus('loading', 'æ­£åœ¨è½¬æ¢...');

            try {
                const startTime = Date.now();
                const response = await fetch(`${API_URL}/convert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hive_sql: hiveSql }),
                });

                const result = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);

                addLog('info', `è½¬æ¢å®Œæˆï¼Œè€—æ—¶ ${duration}s`);
                
                // å­˜å‚¨è½¬æ¢ç»“æœ
                lastConversionResult = {
                    ...result,
                    hive_sql: hiveSql,
                    conversion_time: new Date().toISOString(),
                    duration: duration
                };
                
                // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                document.getElementById('saveBtn').style.display = 'inline-flex';
                
                // Update status cards
                updateResultCards(result);

                if (result.bigquery_sql) {
                    document.getElementById('bqOutput').textContent = result.bigquery_sql;
                }

                if (result.validation_success) {
                    updateStatus('success', 'è½¬æ¢æˆåŠŸ');
                } else {
                    updateStatus('error', 'éªŒè¯å¤±è´¥');
                }

                if (result.success) {
                    addLog('success', 'ğŸ‰ è½¬æ¢å®Œå…¨æˆåŠŸ!');
                }

            } catch (error) {
                addLog('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                updateStatus('error', 'è¯·æ±‚å¤±è´¥');
                document.getElementById('bqOutput').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div>è¯·æ±‚å¤±è´¥: ${escapeHtml(error.message)}</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</div>
                    </div>
                `;
            } finally {
                isConverting = false;
                btn.disabled = false;
                btnText.textContent = 'å¼€å§‹è½¬æ¢';
            }
        }

        // Copy output
        function copyOutput() {
            const output = document.getElementById('bqOutput').textContent;
            if (!output || output.includes('è½¬æ¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º')) {
                addLog('warning', 'æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'å·²å¤åˆ¶!';
                btn.classList.add('copied');
                addLog('success', 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                addLog('error', 'å¤åˆ¶å¤±è´¥: ' + err.message);
            });
        }

        // Save result to file
        function saveResult() {
            if (!lastConversionResult) {
                addLog('warning', 'æ²¡æœ‰å¯ä¿å­˜çš„è½¬æ¢ç»“æœ');
                return;
            }

            const r = lastConversionResult;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const defaultName = `sql_conversion_${timestamp}`;
            
            // è®©ç”¨æˆ·è¾“å…¥æ–‡ä»¶å
            const userInput = prompt('è¯·è¾“å…¥æ–‡ä»¶åï¼ˆä¸éœ€è¦æ‰©å±•åï¼‰:', defaultName);
            if (userInput === null) {
                // ç”¨æˆ·å–æ¶ˆ
                addLog('info', 'å·²å–æ¶ˆä¿å­˜');
                return;
            }
            
            const filename = (userInput.trim() || defaultName) + '.txt';

            // ç”Ÿæˆæ–‡ä»¶å†…å®¹
            let content = `================================================================================
SQL è½¬æ¢æŠ¥å‘Š
================================================================================
ç”Ÿæˆæ—¶é—´: ${r.conversion_time}
è½¬æ¢è€—æ—¶: ${r.duration}s

================================================================================
1. åŸå§‹ Hive SQL
================================================================================
${r.hive_sql}

================================================================================
2. è½¬æ¢åçš„ BigQuery SQL
================================================================================
${r.bigquery_sql || '(è½¬æ¢å¤±è´¥ï¼Œæ— è¾“å‡º)'}

================================================================================
3. æ ¡éªŒç»“æœ
================================================================================
Hive SQL éªŒè¯: ${r.hive_valid ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}
${r.hive_error ? `Hive é”™è¯¯: ${r.hive_error}` : ''}

BigQuery éªŒè¯: ${r.validation_success ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}
éªŒè¯æ¨¡å¼: ${r.validation_mode || 'N/A'}
${r.validation_error ? `éªŒè¯é”™è¯¯: ${r.validation_error}` : ''}

================================================================================
4. è½¬æ¢ç»Ÿè®¡
================================================================================
é‡è¯•æ¬¡æ•°: ${r.retry_count}
æ•´ä½“ç»“æœ: ${r.success ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'}
${r.warning ? `è­¦å‘Š: ${r.warning}` : ''}
`;

            // æ·»åŠ è½¬æ¢å†å²ï¼ˆå¦‚æœæœ‰ï¼‰
            if (r.conversion_history && r.conversion_history.length > 0) {
                content += `
================================================================================
5. è½¬æ¢å†å²
================================================================================
`;
                r.conversion_history.forEach((h, i) => {
                    content += `
--- å°è¯• ${h.attempt} ---
${h.error ? `é”™è¯¯: ${h.error}` : 'æ— é”™è¯¯'}
`;
                });
            }

            content += `
================================================================================
END OF REPORT
================================================================================
`;

            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('saveBtn');
            btn.textContent = 'âœ“ å·²ä¿å­˜';
            btn.classList.add('copied');
            addLog('success', `å·²ä¿å­˜åˆ° ${filename}`);
            
            setTimeout(() => {
                btn.textContent = 'ğŸ’¾ ä¿å­˜';
                btn.classList.remove('copied');
            }, 2000);
        }

        // Check service status on load
        async function checkService() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    updateStatus('success', 'æœåŠ¡å°±ç»ª');
                    addLog('success', 'å·²è¿æ¥åˆ°è½¬æ¢æœåŠ¡');
                    
                    // Get service info
                    const infoResponse = await fetch(`${API_URL}/`);
                    const info = await infoResponse.json();
                    addLog('info', `LLM æä¾›è€…: ${info.llm_provider}`);
                    addLog('info', `éªŒè¯æ¨¡å¼: ${info.validation_mode}`);
                    
                    // Connect to log stream
                    connectLogStream();
                    addLog('info', 'å·²è¿æ¥å®æ—¶æ—¥å¿—æµ');
                }
            } catch (error) {
                updateStatus('error', 'æœåŠ¡æœªè¿æ¥');
                addLog('error', 'æ— æ³•è¿æ¥åˆ°è½¬æ¢æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨');
            }
        }

        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                convertSql();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });

        // Initialize
        checkService();
    </script>
</body>
</html>
