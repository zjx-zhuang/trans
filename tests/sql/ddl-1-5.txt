set hivevar:date_app=${zdt.addDay(-1).format("yyyyMMdd")}_test;


insert overwrite table di_dsjobdb.adm_ibu_overall_trend_analysis partition(d=d)
select channeltype,refername,allianceid,alliancesiteid,methodname as scene,'all' as locale,locale_group,
       pv,uv,
       round(click_query_cnt/ pv, 6)      as click_query_rate,
       round(click_query_cnt_top1/ nullif(click_query_cnt,0), 6)  as top1_click_rate,
       round(click_query_cnt_top3/ nullif(click_query_cnt,0), 6)  as top3_click_rate,
       round(click_query_cnt_top5/ nullif(click_query_cnt,0), 6)  as top5_click_rate,
       round(click_query_cnt_top10/ nullif(click_query_cnt,0), 6) as top10_click_rate,
       round(order_query_cnt_top1/ nullif(order_query_cnt,0), 6)  as top1_order_rate,
       round(order_query_cnt_top3/ nullif(order_query_cnt,0), 6)  as top3_order_rate,
       round(order_query_cnt_top5/ nullif(order_query_cnt,0), 6)  as top5_order_rate,
       round(order_query_cnt_top10/ nullif(order_query_cnt,0), 6) as top10_order_rate,
       round(order_query_cnt/ pv, 6)       as order_query_rate,
       'all' as countryname,
       expo_hotel_count,
       round(click_query_cnt_top20/ nullif(click_query_cnt,0), 6) as top20_click_rate,
       round(order_query_cnt_top20/ nullif(order_query_cnt,0), 6) as top20_order_rate,
       -- twy增加查询口径
       round(click_query_cnt_top1/ pv, 6)  as top1_click_rate_query,
       round(click_query_cnt_top3/ pv, 6)  as top3_click_rate_query,
       round(click_query_cnt_top5/ pv, 6)  as top5_click_rate_query,
       round(click_query_cnt_top10/ pv, 6) as top10_click_rate_query,
       round(order_query_cnt_top1/ pv, 6)  as top1_order_rate_query,
       round(order_query_cnt_top3/ pv, 6)  as top3_order_rate_query,
       round(order_query_cnt_top5/ pv, 6)  as top5_order_rate_query,
       round(order_query_cnt_top10/ pv, 6) as top10_order_rate_query,
       d
from (
  select 
    d, channeltype, refername, allianceid, alliancesiteid,
    case when methodname = 'all' then 'all_list' else methodname end as methodname, -- 整个列表页
    locale_group,
    pv, uv, click_query_cnt, click_query_cnt_top1, click_query_cnt_top3, 
    click_query_cnt_top5, click_query_cnt_top10, click_query_cnt_top20,
    order_query_cnt, order_query_cnt_top1, order_query_cnt_top3, 
    order_query_cnt_top5, order_query_cnt_top10, order_query_cnt_top20,
    expo_hotel_count
  from tmp_htl_dsjobdb.tmp_ibu_overall_agg_detail_${date_app}
  union all
  select 
    d, channeltype, refername, allianceid, alliancesiteid,
    case when methodname = 'all' then 'all_model_list' else methodname end as methodname, -- 只考虑模型作用的主场景列表页
    locale_group,
    pv, uv, click_query_cnt, click_query_cnt_top1, click_query_cnt_top3, 
    click_query_cnt_top5, click_query_cnt_top10, click_query_cnt_top20,
    order_query_cnt, order_query_cnt_top1, order_query_cnt_top3, 
    order_query_cnt_top5, order_query_cnt_top10, order_query_cnt_top20,
    expo_hotel_count
  from tmp_htl_dsjobdb.tmp_ibu_overall_agg_group_${date_app}
) u
;
