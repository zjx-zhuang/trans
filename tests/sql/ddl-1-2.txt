set hivevar:date_app=${zdt.addDay(-1).format("yyyyMMdd")}_test;

drop table if exists tmp_htl_dsjobdb.tmp_ibu_overall_qid_agg_${date_app};
create table tmp_htl_dsjobdb.tmp_ibu_overall_qid_agg_${date_app} as
select  d,
        query_id,
        cid,
        channeltype, refername, allianceid, alliancesiteid,
        method_detail, method_group,
        locale_group,
        -- 是否有点击/下单的最小 rank（若无则为 null）
        min(case when (is_has_click=1 or is_has_order=1) then rank_in_qid_new end) as min_rank_clkord,
        min(case when is_has_order=1 then rank_in_qid_new end)                    as min_rank_order,
        -- 该 query 的曝光酒店数
        count(distinct masterhotelid) as expo_hotel_cnt_q
from    tmp_htl_dsjobdb.tmp_ibu_overall_base_${date_app}
group by d, query_id, cid, channeltype, refername, allianceid, alliancesiteid, method_detail, method_group, locale_group
;
