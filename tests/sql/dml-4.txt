use dwhtl;


insert overwrite table dwhtl.adm_traf_browse_nstandard_tcom_entr_di partition(d)
-- 不分locale
SELECT 'all locales' as locale
       , case when page=10650163454 then 'Homeapge'
              when page=10650163456 then 'List page'
              when page=10650163458 then 'Property content page' 
              else null 
          end as pg_name
       , count(distinct vid) as UV
       , count(distinct vid, sid, pvid) as PV
       -- 分区d                         
       , d
  from dw_htlbizdb.edw_traf_pt_fact_ibu_ubt_pageview
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}'
   and page in (10650163454,10650163456,10650163458)
 group by d
       , case when page=10650163454 then 'Homeapge'
              when page=10650163456 then 'List page'
              when page=10650163458 then 'Property content page' 
              else null 
          end
          
 union all 

select 'all locales' as locale
       , 'Filling-in page' as pg_name
       , count(distinct vid) as UV
       , count(distinct vid,sid,pvid) as PV
       -- 分区d                         
       , d                         
  from dw_htlbizdb.v_edw_traf_ubt_tcom_custom_di
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}'
   and key in ('htl_aptsFillOrd_payment_submitBt_exposure')
   and is_spider = 'F' --剔除爬虫
 group by d

 union all 

select 'all locales' as locale
       , '[Book] button click after info fill-in' as pg_name
       , count(distinct vid) as UV
       , count(distinct vid,sid,pvid) as PV
       -- 分区d                         
       , d                         
  from dw_htlbizdb.v_edw_traf_ubt_tcom_custom_di
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}' 
   and key in ('htl_aptsFillOrd_payment_submitBt_click')
   and is_spider = 'F' --剔除爬虫
 group by d
 
 union all
-- 分locale
SELECT lower(trim(replace(locale,'_','-') )) as locale
       , case when page=10650163454 then 'Homeapge'
              when page=10650163456 then 'List page'
              when page=10650163458 then 'Property content page' 
              else null 
          end as pg_name
       , count(distinct vid) as UV
       , count(distinct vid, sid, pvid) as PV
       -- 分区d                         
       , d                             
  from dw_htlbizdb.edw_traf_pt_fact_ibu_ubt_pageview
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}' 
   and page in (10650163454,10650163456,10650163458)
 group by lower(trim(replace(locale,'_','-') ))
       , case when page=10650163454 then 'Homeapge'
              when page=10650163456 then 'List page'
              when page=10650163458 then 'Property content page' 
              else null 
          end
       , d
       
 union all 
 
select lower(trim(replace(data_info['locale'],'_','-'))) as locale
       , 'Filling-in page' as pg_name
       , count(distinct vid) as UV
       , count(distinct vid,sid,pvid) as PV
       -- 分区d                         
       , d                              
  from dw_htlbizdb.v_edw_traf_ubt_tcom_custom_di
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}' 
   and key in ('htl_aptsFillOrd_payment_submitBt_exposure')
   and is_spider = 'F' --剔除爬虫
 group by lower(trim(replace(data_info['locale'],'_','-')))
       , d
       
 union all 

select lower(trim(replace(data_info['locale'],'_','-'))) as locale
       , '[Book] button click after info fill-in' as page
       , count(distinct vid) as UV
       , count(distinct vid,sid,pvid) as PV
       -- 分区d                         
       , d                              
  from dw_htlbizdb.v_edw_traf_ubt_tcom_custom_di
--  where d >= '2025-03-27' -- 初始化
 where d >= '${zdt.addDay(-7).format("yyyy-MM-dd")}'
   and d < '${zdt.addDay(0).format("yyyy-MM-dd")}' 
   and key in ('htl_aptsFillOrd_payment_submitBt_click')
   and is_spider = 'F' --剔除爬虫
 group by lower(trim(replace(data_info['locale'],'_','-')))
       , d
;
