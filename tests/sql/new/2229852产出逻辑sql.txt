 insert overwrite table dim_hoteldb.dimhotel partition(d = '${zdt.addDay(0).format("yyyy-MM-dd")}')
-- insert overwrite table dwhtl.tmp_cyw_dimhotel_sgp_test partition(d = '${zdt.addDay(0).format("yyyy-MM-dd")}')

select
    t_a.hotel
  , t_a.district
  , t_a.location
  , t_a.hotelname
  , t_a.star
  , t_a.starlicence
  , t_a.hotelcode
  , t_a.balanceperiod
  , t_a.openyear
  , t_a.fitmentyear
  , t_b.fromrailway
  , t_b.fromairport
  , t_b.fromcitycenter
  , t_a.city
  , t_a.hotelbelongto
  , t_a.customereval_del
  , t_a.updatedt
  , t_a.mgrgroup
  , t_a.ratingoverall
  , t_a.effectdate
  , t_a.hotel_engname
  , t_a.roomaudittype_del
  , t_a.fromairport2_del
  , t_a.fromrailway2_del
  , t_a.fromcitycenter2_del
  , t_a.ispkghotel
  , t_a.subwarareaenname
  , t_a.bookable
  , t_a.groupcategory
  , t_a.zone
  , t_a.star_level_id_del
  , t_b.is_standard
  , t_b.novoters
  , t_b.ratingroom
  , t_a.ratingatmosphere_del
  , t_b.ratingservice
  , t_b.ratingcostbenefit
  , t_a.sendinvoicefirst_del
  , t_a.hoteldeposit_del
  , t_a.depositreason_del
  , t_a.auditeid
  , t_a.commissioneid
  , t_a.integrationtype
  , t_a.isebookinghtl
  , t_a.orderconfirmtype
  , t_a.goldstar
  , t_a.ishtswtitch_del
  , t_a.confirmtype_del
  , t_a.isstraightconnect
  , t_a.enghoteldesc
  , t_a.ac_ctripname_del
  , t_a.diy_breakfast_del
  , t_a.contactor
  , t_a.address
  , t_a.telephone
  , t_a.fax_del
  , t_a.email_del
  , t_a.brand
  , t_a.zipcode
  , t_a.htlaccontactor
  , t_a.htlacfax
  , t_a.htlactel
  , t_a.invoicereceiver_del
  , t_a.roomquantity
  , t_a.isdsmallhotel_del
  , t_a.accchecktype_del
  , t_a.contractdate
  , t_a.is_testhotel
  , t_a.salestel
  , t_a.executivename
  , t_a.executivetel
  , t_a.executiveemail
  , t_a.salesmanagername
  , t_a.salesmanagertel
  , t_a.salesmanageremail
  , t_a.revmanagername
  , t_a.revmanagertel
  , t_a.revmanageremail
  , t_a.invoicehead_del
  , t_a.isemailrecon_del
  , t_a.invoicebody_del
  , t_a.ishwgroup_del
  , t_a.auditstatementmodule_del
  , t_a.is_provide_telephone
  , t_a.isopened
  , t_a.is_provide_email
  , t_a.west_breakfast_del
  , t_a.close_reason_type_id
  , t_a.close_reason_type_name
  , t_a.masterhotelid
  , t_a.breakfastcurrency_del
  , t_a.glon
  , t_a.glat
  , t_a.hoteldesc
  , t_a.arrivalfrom
  , t_a.arrivalto
  , t_a.departurefrom
  , t_a.departureto
  , t_a.star_level
  , t_a.lat
  , t_a.lon
  , t_a.onlinesale_del
  , t_a.gdlat
  , t_a.gdlon
  , t_a.zone2
  , t_a.licenceexpirydate
  , t_a.cooperation_type
  , t_a.servicefee
  , t_a.isagent
  , t_a.salesmobilephone
  , t_a.executivemobilephone
  , t_a.salesmanagermobilephone
  , t_a.revmanagermobilephone
  , t_a.hotelnameabbreviation
  , t_a.pinyinhead
  , t_a.countryid
  , t_a.supplierid
  , t_a.actualmasterhotelid
  , t_a.countryname
  , t_a.masterstar
  , t_a.mastercity
  , t_a.mastercityname
  , t_a.mastercountryid
  , t_a.mastercountryname
  , cast(t_b.ratingposit as decimal(18,4)) as ratingposit  -- 因为目标表是double类型，精度会缺失，处理成同别的rating字段的类型decimal(18,4)
  , t_b.recommend
  , t_a.masterprovinceid
  , t_a.masterprovincename
  , t_a.isfamilystay
  , t_a.hotelcnname
  , t_a.groupid
  , t_a.last_valid_city
  , t_a.last_valid_cityname
  , t_a.last_valid_provinceid
  , t_a.last_valid_provincename
  , t_a.last_valid_countryid
  , t_a.last_valid_countryname
  , t_a.engaddress
  , t_a.hotelcategory
  , t_a.last_valid_mastercity
  , t_a.last_valid_mastercityname
  , t_a.last_valid_masterprovinceid
  , t_a.last_valid_masterprovincename
  , t_a.last_valid_mastercountryid
  , t_a.last_valid_mastercountryname
  , t_a.mastermgrgroup
  , t_a.tel
  , t_a.hotelenname
  , t_a.hotelshortname
  , case when t_a.masterhotelid = 0 then t_b.mastergoldstar when (t_a.masterhotelid > 0 or t_a.masterhotelid = -1) then coalesce(t_b.mastergoldstar,0) else null end as mastergoldstar
  , case when t_a.masterhotelid = 0 then t_b.mastergoldstarname when (t_a.masterhotelid > 0 or t_a.masterhotelid = -1) then coalesce(t_b.mastergoldstarname,'无牌') else null end as mastergoldstarname
  , case when t_a.masterhotelid = 0 then t_b.mastergoldstarenname when (t_a.masterhotelid > 0 or t_a.masterhotelid = -1) then coalesce(t_b.mastergoldstarenname,'') else null end as mastergoldstarenname
  , t_a.masterbookable
  , t_a.global_type
  , t_b.hotel_type
  , t_b.hotel_typename
  , t_a.grouptype
  , t_a.suppliername
  , t_a.isenable
  , t_a.ismip
  , t_b.ifnewhotel
  , t_b.ifbenchmark
  , t_a.ifim
  , t_a.cmlable
  , t_a.ifbuyout
  , t_a.locationname
  , t_a.locationenname
  , t_a.masterlocation
  , t_a.masterlocationname
  , t_a.masterlocationenname
  , t_a.cityid
  , t_a.cityname
  , t_a.cityenname
  , t_a.mastercityid
  , t_a.mastercityenname
  , t_a.provinceid
  , t_a.provincename
  , t_a.provinceenname
  , t_a.masterprovinceenname
  , t_a.countryenname
  , t_a.mastercountryenname
  , t_a.mastercontinentid
  , t_a.mastercontinentname
  , t_a.mastercontinentenname
  , t_a.pcityid
  , t_a.pcityname
  , t_a.masterpcityid
  , t_a.masterpcityname
  , t_b.masterbigcityid
  , t_b.masterbigcityname
  , t_b.masterbigcityenname
  , t_a.is_top5group_del
  , t_b.is_top8group
  , t_a.zonename
  , t_a.zoneenname
  , t_b.masterzone
  , t_b.masterzonename
  , t_b.masterzoneenname
  , t_a.zonename2
  , t_b.masterzone2
  , t_b.masterzonename2
  , t_a.districtname
  , t_a.masterdistrictname
  , t_a.groupname
  , t_a.groupenname
  , t_a.mgrgroupname
  , t_a.mgrgroupenname
  , t_a.mastermgrgroupname
  , t_a.mastermgrgroupenname
  , t_a.brandname
  , t_a.masterbrand
  , t_a.masterbrandname
  , cast(t_b.hotelrating as decimal(18,4)) as hotelrating  -- 因为目标表是double类型，精度会缺失，处理成同别的rating字段的类型decimal(18,4)
  , t_b.psi_map
  , t_b.level
  , t_a.changereasonitemid
  , t_a.changereasonitemname
  , t_a.opendate
  , t_a.fitmentdate
  , t_a.effecttime
  , t_a.brandtype
  , t_a.masterbrandtype
  , t_a.masterhotelname
  , t_a.area
  , t_a.area_en
  , t_a.area1
  , t_a.area1_en
  , t_a.issupportanticipation
  , t_a.last_bookable_time
  , t_a.brandenname
  , t_a.masterstarlicence
  , case when t_a.masterhotelid = 0 then t_b.mastergoldstar_ori when (t_a.masterhotelid > 0 or t_a.masterhotelid = -1) then coalesce(t_b.mastergoldstar_ori,0) else null end as mastergoldstar_ori
  , t_a.masteropendate
  , t_a.masterfitmentdate
  , t_a.mastereffectdate
  , t_a.masterlon
  , t_a.masterlat
  , t_a.masterglon
  , t_a.masterglat
  , t_a.mastergdlon
  , t_a.mastergdlat
  , t_a.mastertelephone
  , t_a.dc_typeid
  , t_a.dc_typename
  , t_a.isdiscount
  , t_b.masterbrandcnname
  , t_a.masterbrandenname
  , t_b.mgrgrouptag
  , t_a.room_cnt_prpt
  , t_a.balanceperiod_del
  , t_a.close_reason_enname
  , t_a.invt_set
  , t_a.datachange_createtime

from (
    -- SGP环境的子酒维表的T-1分区中不需要更新的记录，即除去差异表T0分区中比较类型为del/update的记录
    select
        t0.hotel
      , t0.district
      , t0.location
      , t0.hotelname
      , t0.star
      , t0.starlicence
      , t0.hotelcode
      , null as balanceperiod
      , t0.openyear
      , t0.fitmentyear
      , t0.city
      , t0.hotelbelongto
      , t0.customereval_del
      , t0.updatedt
      , t0.mgrgroup
      , t0.ratingoverall
      , t0.effectdate
      , t0.hotel_engname
      , t0.roomaudittype_del
      , t0.fromairport2_del
      , t0.fromrailway2_del
      , t0.fromcitycenter2_del
      , t0.ispkghotel
      , t0.subwarareaenname
      , t0.bookable
      , t0.groupcategory
      , t0.zone
      , t0.star_level_id_del
      , t0.ratingatmosphere_del
      , t0.sendinvoicefirst_del
      , t0.hoteldeposit_del
      , t0.depositreason_del
      , t0.auditeid
      , t0.commissioneid
      , t0.integrationtype
      , t0.isebookinghtl
      , t0.orderconfirmtype
      , t0.goldstar
      , t0.ishtswtitch_del
      , t0.confirmtype_del
      , t0.isstraightconnect
      , t0.enghoteldesc
      , t0.ac_ctripname_del
      , t0.diy_breakfast_del
      , t0.contactor
      , t0.address
      , t0.telephone
      , t0.fax_del
      , t0.email_del
      , t0.brand
      , t0.zipcode
      , t0.htlaccontactor
      , t0.htlacfax
      , t0.htlactel
      , t0.invoicereceiver_del
      , t0.roomquantity
      , t0.isdsmallhotel_del
      , t0.accchecktype_del
      , t0.contractdate
      , t0.is_testhotel
      , t0.salestel
      , t0.executivename
      , t0.executivetel
      , t0.executiveemail
      , t0.salesmanagername
      , t0.salesmanagertel
      , t0.salesmanageremail
      , t0.revmanagername
      , t0.revmanagertel
      , t0.revmanageremail
      , t0.invoicehead_del
      , t0.isemailrecon_del
      , t0.invoicebody_del
      , t0.ishwgroup_del
      , t0.auditstatementmodule_del
      , t0.is_provide_telephone
      , t0.isopened
      , t0.is_provide_email
      , t0.west_breakfast_del
      , t0.close_reason_type_id
      , t0.close_reason_type_name
      , t0.masterhotelid
      , null as breakfastcurrency_del
      , t0.glon
      , t0.glat
      , t0.hoteldesc
      , t0.arrivalfrom
      , t0.arrivalto
      , t0.departurefrom
      , t0.departureto
      , t0.star_level
      , t0.lat
      , t0.lon
      , null as onlinesale_del
      , t0.gdlat
      , t0.gdlon
      , t0.zone2
      , t0.licenceexpirydate
      , t0.cooperation_type
      , t0.servicefee
      , t0.isagent
      , t0.salesmobilephone
      , t0.executivemobilephone
      , t0.salesmanagermobilephone
      , t0.revmanagermobilephone
      , t0.hotelnameabbreviation
      , t0.pinyinhead
      , t0.countryid
      , t0.supplierid
      , t0.actualmasterhotelid
      , t0.countryname
      , t0.masterstar
      , t0.mastercity
      , t0.mastercityname
      , t0.mastercountryid
      , t0.mastercountryname
      , t0.masterprovinceid
      , t0.masterprovincename
      , t0.isfamilystay
      , t0.hotelcnname
      , t0.groupid
      , t0.last_valid_city
      , t0.last_valid_cityname
      , t0.last_valid_provinceid
      , t0.last_valid_provincename
      , t0.last_valid_countryid
      , t0.last_valid_countryname
      , t0.engaddress
      , t0.hotelcategory
      , t0.last_valid_mastercity
      , t0.last_valid_mastercityname
      , t0.last_valid_masterprovinceid
      , t0.last_valid_masterprovincename
      , t0.last_valid_mastercountryid
      , t0.last_valid_mastercountryname
      , t0.mastermgrgroup
      , t0.tel
      , t0.hotelenname
      , t0.hotelshortname
      , t0.masterbookable
      , t0.global_type
      , t0.grouptype
      , t0.suppliername
      , t0.isenable
      , t0.ismip
      , t0.ifim
      , t0.cmlable
      , t0.ifbuyout
      , t0.locationname
      , t0.locationenname
      , t0.masterlocation
      , t0.masterlocationname
      , t0.masterlocationenname
      , t0.cityid
      , t0.cityname
      , t0.cityenname
      , t0.mastercityid
      , t0.mastercityenname
      , t0.provinceid
      , t0.provincename
      , t0.provinceenname
      , t0.masterprovinceenname
      , t0.countryenname
      , t0.mastercountryenname
      , t0.mastercontinentid
      , t0.mastercontinentname
      , t0.mastercontinentenname
      , t0.pcityid
      , t0.pcityname
      , t0.masterpcityid
      , t0.masterpcityname
      , t0.is_top5group_del
      , t0.zonename
      , t0.zoneenname
      , t0.zonename2
      , t0.districtname
      , t0.masterdistrictname
      , t0.groupname
      , t0.groupenname
      , t0.mgrgroupname
      , t0.mgrgroupenname
      , t0.mastermgrgroupname
      , t0.mastermgrgroupenname
      , t0.brandname
      , t0.masterbrand
      , t0.masterbrandname
      , t0.changereasonitemid
      , t0.changereasonitemname
      , t0.opendate
      , t0.fitmentdate
      , t0.effecttime
      , t0.brandtype
      , t0.masterbrandtype
      , t0.masterhotelname
      , t0.area
      , t0.area_en
      , t0.area1
      , t0.area1_en
      , t0.issupportanticipation
      , t0.last_bookable_time
      , t0.brandenname
      , t0.masterstarlicence
      , t0.masteropendate
      , t0.masterfitmentdate
      , t0.mastereffectdate
      , t0.masterlon
      , t0.masterlat
      , t0.masterglon
      , t0.masterglat
      , t0.mastergdlon
      , t0.mastergdlat
      , t0.mastertelephone
      , t0.dc_typeid
      , t0.dc_typename
      , t0.isdiscount
      , t0.masterbrandenname
      , t0.room_cnt_prpt
      , t0.balanceperiod_del
      , t0.close_reason_enname
      , t0.invt_set
      , t0.datachange_createtime
    from (
        select *
        from dim_hoteldb.dimhotel
        where d = '${zdt.addDay(-1).format("yyyy-MM-dd")}'
    ) t0
    left anti join (
        select hotel
        from dim_hoteldb.dim_stinf_htl_hotel_compare_result_df  -- 差异表：dimhotel
        where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
          and compare_result_type in ('del', 'update')
    ) t1 on t0.hotel = t1.hotel


    union all

    -- 上述子酒维表需要更新的记录，即差异表中比较类型为add/update的记录
    select
        t0.hotel
      , t0.district
      , t0.location
      , t0.hotelname
      , t0.star
      , t0.starlicence
      , t0.hotelcode
      , null as balanceperiod
      , t0.openyear
      , t0.fitmentyear
      , t0.city
      , t0.hotelbelongto
      , t0.customereval_del
      , t0.updatedt
      , t0.mgrgroup
      , t0.ratingoverall
      , t0.effectdate
      , t0.hotel_engname
      , t0.roomaudittype_del
      , t0.fromairport2_del
      , t0.fromrailway2_del
      , t0.fromcitycenter2_del
      , t0.ispkghotel
      , t0.subwarareaenname
      , t0.bookable
      , t0.groupcategory
      , t0.zone
      , t0.star_level_id_del
      , t0.ratingatmosphere_del
      , t0.sendinvoicefirst_del
      , t0.hoteldeposit_del
      , t0.depositreason_del
      , t0.auditeid
      , t0.commissioneid
      , t0.integrationtype
      , t0.isebookinghtl
      , t0.orderconfirmtype
      , t0.goldstar
      , t0.ishtswtitch_del
      , t0.confirmtype_del
      , t0.isstraightconnect
      , t0.enghoteldesc
      , t0.ac_ctripname_del
      , t0.diy_breakfast_del
      , t0.contactor
      , t0.address
      , t0.telephone
      , t0.fax_del
      , t0.email_del
      , t0.brand
      , t0.zipcode
      , t0.htlaccontactor
      , t0.htlacfax
      , t0.htlactel
      , t0.invoicereceiver_del
      , t0.roomquantity
      , t0.isdsmallhotel_del
      , t0.accchecktype_del
      , t0.contractdate
      , t0.is_testhotel
      , t0.salestel
      , t0.executivename
      , t0.executivetel
      , t0.executiveemail
      , t0.salesmanagername
      , t0.salesmanagertel
      , t0.salesmanageremail
      , t0.revmanagername
      , t0.revmanagertel
      , t0.revmanageremail
      , t0.invoicehead_del
      , t0.isemailrecon_del
      , t0.invoicebody_del
      , t0.ishwgroup_del
      , t0.auditstatementmodule_del
      , t0.is_provide_telephone
      , t0.isopened
      , t0.is_provide_email
      , t0.west_breakfast_del
      , t0.close_reason_type_id
      , t0.close_reason_type_name
      , t0.masterhotelid
      , null as breakfastcurrency_del
      , t0.glon
      , t0.glat
      , t0.hoteldesc
      , t0.arrivalfrom
      , t0.arrivalto
      , t0.departurefrom
      , t0.departureto
      , t0.star_level
      , t0.lat
      , t0.lon
      , null as onlinesale_del
      , t0.gdlat
      , t0.gdlon
      , t0.zone2
      , t0.licenceexpirydate
      , t0.cooperation_type
      , t0.servicefee
      , t0.isagent
      , t0.salesmobilephone
      , t0.executivemobilephone
      , t0.salesmanagermobilephone
      , t0.revmanagermobilephone
      , t0.hotelnameabbreviation
      , t0.pinyinhead
      , t0.countryid
      , t0.supplierid
      , t0.actualmasterhotelid
      , t0.countryname
      , t0.masterstar
      , t0.mastercity
      , t0.mastercityname
      , t0.mastercountryid
      , t0.mastercountryname
      , t0.masterprovinceid
      , t0.masterprovincename
      , t0.isfamilystay
      , t0.hotelcnname
      , t0.groupid
      , t0.last_valid_city
      , t0.last_valid_cityname
      , t0.last_valid_provinceid
      , t0.last_valid_provincename
      , t0.last_valid_countryid
      , t0.last_valid_countryname
      , t0.engaddress
      , t0.hotelcategory
      , t0.last_valid_mastercity
      , t0.last_valid_mastercityname
      , t0.last_valid_masterprovinceid
      , t0.last_valid_masterprovincename
      , t0.last_valid_mastercountryid
      , t0.last_valid_mastercountryname
      , t0.mastermgrgroup
      , t0.tel
      , t0.hotelenname
      , t0.hotelshortname
      , t0.masterbookable
      , t0.global_type
      , t0.grouptype
      , t0.suppliername
      , t0.isenable
      , t0.ismip
      , t0.ifim
      , t0.cmlable
      , t0.ifbuyout
      , t0.locationname
      , t0.locationenname
      , t0.masterlocation
      , t0.masterlocationname
      , t0.masterlocationenname
      , t0.cityid
      , t0.cityname
      , t0.cityenname
      , t0.mastercityid
      , t0.mastercityenname
      , t0.provinceid
      , t0.provincename
      , t0.provinceenname
      , t0.masterprovinceenname
      , t0.countryenname
      , t0.mastercountryenname
      , t0.mastercontinentid
      , t0.mastercontinentname
      , t0.mastercontinentenname
      , t0.pcityid
      , t0.pcityname
      , t0.masterpcityid
      , t0.masterpcityname
      , t0.is_top5group_del
      , t0.zonename
      , t0.zoneenname
      , t0.zonename2
      , t0.districtname
      , t0.masterdistrictname
      , t0.groupname
      , t0.groupenname
      , t0.mgrgroupname
      , t0.mgrgroupenname
      , t0.mastermgrgroupname
      , t0.mastermgrgroupenname
      , t0.brandname
      , t0.masterbrand
      , t0.masterbrandname
      , t0.changereasonitemid
      , t0.changereasonitemname
      , t0.opendate
      , t0.fitmentdate
      , t0.effecttime
      , t0.brandtype
      , t0.masterbrandtype
      , t0.masterhotelname
      , t0.area
      , t0.area_en
      , t0.area1
      , t0.area1_en
      , t0.issupportanticipation
      , t0.last_bookable_time
      , t0.brandenname
      , t0.masterstarlicence
      , t0.masteropendate
      , t0.masterfitmentdate
      , t0.mastereffectdate
      , t0.masterlon
      , t0.masterlat
      , t0.masterglon
      , t0.masterglat
      , t0.mastergdlon
      , t0.mastergdlat
      , t0.mastertelephone
      , t0.dc_typeid
      , t0.dc_typename
      , t0.isdiscount
      , t0.masterbrandenname
      , t0.room_cnt_prpt
      , t0.balanceperiod_del
      , t0.close_reason_enname
      , t0.invt_set
      , t0.datachange_createtime
    from dim_hoteldb.dim_stinf_htl_hotel_compare_result_df t0
    where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
      and compare_result_type in ('add', 'update')
) t_a
left join (
    select 
        masterhotelid
      , is_standard
      , level
      , hotel_type
      , hotel_typename
      , goldstar_ori as mastergoldstar_ori
      , goldstar as mastergoldstar
      , goldstarname as mastergoldstarname
      , goldstarenname as mastergoldstarenname
      , brandcnname as masterbrandcnname  -- 母酒店中文名称
      , mgrgrouptag
      , is_top8group
      , bigcityid as masterbigcityid
      , bigcityname as masterbigcityname
      , bigcityenname as masterbigcityenname
      , zone as masterzone
      , zonename as masterzonename
      , zoneenname as masterzoneenname
      , zone2 as masterzone2
      , zonename2 as masterzonename2
      , psi_map
      , ifnewhotel
      , ifbenchmark
      , hotelrating     -- 最外层处理精度缺失问题
      , novoters
      , ratingroom
      , ratingservice
      , ratingcostbenefit
      , ratingposit     -- 最外层处理精度缺失问题
      , recommend
      , fromrailway
      , fromairport
      , fromcitycenter
    from dim_hoteldb.dimmasterhotel
    where d in ('${zdt.format("yyyy-MM-dd")}','9999-12-31')
) t_b on t_a.actualmasterhotelid = t_b.masterhotelid
;
