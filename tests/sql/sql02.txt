use dw_htlbizdb;

with tmp_kwfu_table as (
    select
        event_id
        ,key
        ,channeltype --渠道
        ,t.starttime --埋点触发时间
        ,t.cid --  用户设备标识
        ,t.uid--用户id
        ,t.vid --用户唯一标识，主要是非app统计用户数用
        ,t.pvid --页面自增长ID
        ,t.sid --会话ID
        ,t.page  --页面ID/CODE
        ,appversion --客户端app版本号
        ,regexp_replace(checkin,'^(\\d{4})[/\-]?(\\d{2})[/\-]?(\\d{2})$','$1-$2-$3') as checkin --入住日期
        ,regexp_replace(checkout,'^(\\d{4})[/\-]?(\\d{2})[/\-]?(\\d{2})$','$1-$2-$3') as checkout --离店日期
        ,roomnum  --房间数
        ,adultnum--成人数
        ,childnum  --儿童数
        ,nvl(srmlist,'[]') as srmlist --房型列表 -- null时设置为[],与udf.json_split兼容
        ,rmlist_tracelogid --房型列表服务ID
        ,allianceid --aid
        ,alliancesiteid --sid
        ,is_spider --
        ,locale --站点
        ,t.data['domain'] as domain 
        ,is_meta 
        ,masterhotelid 
        ,isnoprice 
        ,userip --客户端ip
        ,get_json_object(lower(t.data['value']),'$.user_level') as user_level --用户等级身份
        ,childage
        --2023-03-28 kw.fu
        ,hotelpriceroomid
        ,hotelprice
        ,sourcetype
        ,source_id
        ,ouid
        ,datacenter
        ,couponinfo    --优惠券信息list
        ,mergedRoomInfos -- 合并房型信息List
        -- 2023-12-08 曾金平
        ,meta_roomid    -- #投放房型的roomid
        ,isvalid_case    -- #是否是有效case，字段未埋就是有效，无效则埋具体无效原因
        ,meta_avgprice    -- #投放的税前均价
        ,meta_totalprice --#投放的税后总价
        ,org_rmlist --原始roomlist节点
        ,time_gap
        ,hotelroomtype -- 需要监控的价格一致性类型:1起价房型 2指定房型
        ,hoteldeleteprice --酒店划线价
        ,hotelpriceroomtoken --房型编号
        ,pre_masterhotelid_tracelogid 
        ,is_landdtl 
        ,meta_vendorid 
        ,spider_type
        ,is_CaliforniaPrice
        ,fullroom_reason
        ,bookableDateList
        ,filterlist_main
        ,showtype_main
        ,is_includetaxpayhotel
        ,meta_rateid,meta_rateplanid
        ,t.d
        ,t.h
    from dw_htlbizdb.edw_traf_ht_htl_servercustom_hour_new t 
    lateral view json_tuple(t.data['value'],
        'channeltype', 'appversion', 'checkin', 'checkout', 'roomnum', 'adultnum', 'childnum', 
        'srmlist', 'rmlist_tracelogid', 'allianceid', 'alliancesiteid', 'is_spider', 'locale', 
        'is_meta', 'masterhotelid', 'isnoprice', 'userip', 'childage', 'hotelpriceroomid', 
        'hotelprice', 'sourcetype', 'source_id', 'ouid', 'datacenter', 'couponinfo', 'mergedRoomInfos',
        'meta_roomid', 'isvalid_case', 'meta_avgprice', 'meta_totalprice', 'org_rmlist', 'time_gap',
        'hotelroomtype', 'hoteldeleteprice', 'hotelpriceroomtoken', 'pre_masterhotelid_tracelogid',
        'is_landdtl', 'meta_vendorid', 'spider_type', 'is_CaliforniaPrice', 'fullroom_reason',
        'bookableDateList', 'filterlist', 'showType', 'is_includetaxpayhotel','meta_rateid','meta_rateplanid'
    ) jt as channeltype, appversion, checkin, checkout, roomnum, adultnum, childnum, 
        srmlist, rmlist_tracelogid, allianceid, alliancesiteid, is_spider, locale, 
        is_meta, masterhotelid, isnoprice, userip, childage, hotelpriceroomid, 
        hotelprice, sourcetype, source_id, ouid, datacenter, couponinfo, mergedRoomInfos,
        meta_roomid, isvalid_case, meta_avgprice, meta_totalprice, org_rmlist, time_gap,
        hotelroomtype, hoteldeleteprice, hotelpriceroomtoken, pre_masterhotelid_tracelogid,
        is_landdtl, meta_vendorid, spider_type, is_CaliforniaPrice, fullroom_reason,
        bookableDateList, filterlist_main, showtype_main, is_includetaxpayhotel,meta_rateid,meta_rateplanid
    where t.d='${zdt.add(10,-1).format("yyyy-MM-dd")}' 
        and t.h='${zdt.add(10,-1).format("HH")}' 
        and t.key = 'trip_rmlist_server_ser'
        and nvl(t.data['value'],'')<>''
        and coalesce(get_json_object(t.data['value'],'$.from_env'),'') not in ('mirror')
),
exploded_data as (
    select
        t.*
        ,r.rm_json 
        ,roomid
        ,room_token
        ,rateplanid
        ,currency
        ,rm_dispatchid, isguessyoulike, fq_price, fh_price, fh_price_total, fh_price_avg, 
        tax, tax_total, tax_avg, cost, shadowid, maskid, pkg_id, ishourroom, isbookable, 
        bedtype, meal, mealnum, area, cancelpolicy, iscomfirm, roomperson, comfirmhour, 
        guaranteetype, paytype, promotionlist, filterlist, age, smokeinfo, cancelpriceinfo, 
        showpriceinfo, showwithtaxpriceinfo, deduct, refund, iswifi, confirmpolicy, 
        minstartrooms, maxstartrooms, windowinfo, isfullapply, roomtype, exchange, 
        floorpiece, fh_price_avg_alltax, fh_price_total_alltax, showtype, guestsnum, 
        isVeilDiffPriceZero, sceneType, isroomlist, ismeta_show, roomtag, prepayDiscountList, 
        cost_promotion, remainRoomQuantity, rank, mealType, basicroomid, is_start_room, 
        ismultiroomrecommend, recommend_roomnum, isentityroom, packagecontent, cancelPolicyType, 
        cancelpolicy_desc, cancelLadderDetails, is_presale_frontload, presale_pkgid, 
        presale_price, roomperson_adult, roomperson_child, entityroom_desc, iscombine_ser, 
        avgprice_beforetax, isMaskRoom, bedtypeCategory, pkgSaleInfo, afterBookingFreeCancelTime, 
        CancelPolicyNewType, child_tag_checkin, child_tag_meal, combined_room_info, 
        recommendtype, noprice, vendorid, xpkg_id, xpkg_type, meal_prompt_tag, rm_taglist, 
        coins_quantity, is_extra_coins, roomrecommend_status, iscompensate, incentiveTagList,rateid
    from tmp_kwfu_table t
    lateral view outer explode(udf.json_split(t.srmlist)) r as rm_json
    lateral view json_tuple(rm_json,
        'roomid', 'room_token', 'rm_dispatchid', 'isguessyoulike', 'fq_price', 'fh_price', 
        'fh_price_total', 'fh_price_avg', 'tax', 'tax_total', 'tax_avg', 'cost', 'shadowid', 
        'maskid', 'pkg_id', 'ishourroom', 'isbookable', 'bedtype', 'meal', 'mealnum', 'area', 
        'cancelpolicy', 'iscomfirm', 'roomperson', 'comfirmhour', 'guaranteetype', 'paytype', 
        'promotionlist', 'filterlist', 'age', 'smokeinfo', 'cancelpriceinfo', 'showpriceinfo', 
        'showwithtaxpriceinfo', 'deduct', 'refund', 'iswifi', 'confirmpolicy', 'minstartrooms', 
        'maxstartrooms', 'windowinfo', 'isfullapply', 'roomtype', 'exchange', 'floorpiece', 
        'fh_price_avg_alltax', 'fh_price_total_alltax', 'rateplanid', 'currency', 'showtype', 'guestsnum', 
        'isVeilDiffPriceZero', 'sceneType', 'isroomlist', 'ismeta_show', 'roomtag', 
        'prepayDiscountList', 'cost_promotion', 'remainRoomQuantity', 'rank', 'mealType', 
        'basicroomid', 'is_start_room', 'ismultiroomrecommend', 'recommend_roomnum', 
        'isentityroom', 'packagecontent', 'cancelPolicyType', 'cancelpolicy_desc', 
        'cancelLadderDetails', 'is_presale_frontload', 'presale_pkgid', 'presale_price', 
        'roomperson_adult', 'roomperson_child', 'entityroom_desc', 'iscombine_ser', 
        'avgprice_beforetax', 'isMaskRoom', 'bedtypeCategory', 'pkgSaleInfo', 
        'afterBookingFreeCancelTime', 'CancelPolicyNewType', 'child_tag_checkin', 
        'child_tag_meal', 'combined_room_info', 'recommendtype', 'noprice', 'vendorid', 
        'xpkg_id', 'xpkg_type', 'meal_prompt_tag', 'rm_taglist', 'coins_quantity', 
        'is_extra_coins', 'roomrecommend_status', 'iscompensate', 'incentiveTagList','rateid'
    ) jt as roomid, room_token, rm_dispatchid, isguessyoulike, fq_price, fh_price, 
        fh_price_total, fh_price_avg, tax, tax_total, tax_avg, cost, shadowid, maskid, 
        pkg_id, ishourroom, isbookable, bedtype, meal, mealnum, area, cancelpolicy, 
        iscomfirm, roomperson, comfirmhour, guaranteetype, paytype, promotionlist, 
        filterlist, age, smokeinfo, cancelpriceinfo, showpriceinfo, showwithtaxpriceinfo, 
        deduct, refund, iswifi, confirmpolicy, minstartrooms, maxstartrooms, windowinfo, 
        isfullapply, roomtype, exchange, floorpiece, fh_price_avg_alltax, fh_price_total_alltax, 
        rateplanid, currency, showtype, guestsnum, isVeilDiffPriceZero, sceneType, isroomlist, 
        ismeta_show, roomtag, prepayDiscountList, cost_promotion, remainRoomQuantity, 
        rank, mealType, basicroomid, is_start_room, ismultiroomrecommend, recommend_roomnum, 
        isentityroom, packagecontent, cancelPolicyType, cancelpolicy_desc, cancelLadderDetails, 
        is_presale_frontload, presale_pkgid, presale_price, roomperson_adult, roomperson_child, 
        entityroom_desc, iscombine_ser, avgprice_beforetax, isMaskRoom, bedtypeCategory, 
        pkgSaleInfo, afterBookingFreeCancelTime, CancelPolicyNewType, child_tag_checkin, 
        child_tag_meal, combined_room_info, recommendtype, noprice, vendorid, xpkg_id, 
        xpkg_type, meal_prompt_tag, rm_taglist, coins_quantity, is_extra_coins, 
        roomrecommend_status, iscompensate, incentiveTagList,rateid
)

